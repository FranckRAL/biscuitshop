{% extends 'shop/base.html' %}
{% load static %}

{% block title %}Payment Processing - Biscuit Shop{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-lg">
                <div class="card-body text-center p-5">
                    <div class="mb-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    
                    <h3 class="card-title mb-3">Payment Processing</h3>
                    <p class="text-muted mb-4" id="status-message">
                        Please wait while we process your payment...
                    </p>
                    
                    <div class="alert alert-info mb-4">
                        <strong>Order #{{ order.id }}</strong><br>
                        Amount: <strong>{{ order.total_price }} Ar</strong>
                    </div>
                    
                    <div class="payment-status mb-4">
                        <p class="mb-2">
                            <i class="fas fa-mobile-alt"></i>
                            Payment Method: <strong>{{ order.get_payment_method_display }}</strong>
                        </p>
                        {% if order.customer_phone %}
                        <p class="mb-0">
                            Phone: <strong>{{ order.customer_phone }}</strong>
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="progress mb-3" style="height: 20px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar" style="width: 100%" id="progress-bar">
                        </div>
                    </div>
                    
                    <p class="text-muted small mb-3" id="status-text">
                        Checking payment status... (Attempt: <span id="attempt">1</span>)
                    </p>
                    
                    <a href="{% url 'home' %}" class="btn btn-secondary btn-sm">
                        Back to Home
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const orderId = {{ order.id }};
    const checkStatusUrl = "{% url 'check_payment_status' order_id=order.id %}";
    let attempt = 0;
    let maxAttempts = 60; // 5 minutes with 5-second intervals
    let checkInterval = null;
    
    function checkPaymentStatus() {
        attempt++;
        document.getElementById('attempt').textContent = attempt;
        
        fetch(checkStatusUrl)
            .then(response => response.json())
            .then(data => {
                console.log('Payment status:', data);
                
                if (data.status === 'completed') {
                    // Payment successful
                    clearInterval(checkInterval);
                    document.getElementById('status-message').textContent = 
                        'Payment completed! Redirecting...';
                    document.getElementById('status-message').className = 
                        'text-success mb-4';
                    
                    setTimeout(() => {
                        window.location.href = data.redirect_url;
                    }, 1000);
                } 
                else if (data.status === 'failed') {
                    // Payment failed
                    clearInterval(checkInterval);
                    document.getElementById('status-message').textContent = 
                        'Payment failed. Please try again.';
                    document.getElementById('status-message').className = 
                        'text-danger mb-4';
                    document.querySelector('.spinner-border').style.display = 'none';
                    document.getElementById('progress-bar').className = 
                        'progress-bar bg-danger';
                }
                else {
                    // Still pending
                    if (attempt >= maxAttempts) {
                        clearInterval(checkInterval);
                        document.getElementById('status-message').textContent = 
                            'Payment is taking longer than expected. Please check your account.';
                        document.getElementById('status-message').className = 
                            'text-warning mb-4';
                    }
                }
            })
            .catch(error => {
                console.error('Error checking status:', error);
                document.getElementById('status-message').textContent = 
                    'Error checking payment status. Retrying...';
                document.getElementById('status-message').className = 
                    'text-warning mb-4';
            });
    }
    
    // Start checking immediately, then every 5 seconds
    checkPaymentStatus();
    checkInterval = setInterval(checkPaymentStatus, 5000);
    
    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (checkInterval) clearInterval(checkInterval);
    });
</script>
{% endblock %}